<%= render :partial => 'issue_statistics/search' %>
<hr />
<% if @issue_statistics.empty? %>
  <p class="nodata"><%= l(:label_no_data_or_access_denied) %></p>
<% else %>
   <% @issue_statistics.group_by(&:statisticable_id).each do |stat_per_user, tab| %>
      <% periods = [] %>
      <% str = {} %>
      <% statisticable =  nil %>
      <% relate_id =  nil %>
      <% tab.each do |stat| %>
        <% statisticable ||=  stat.statisticable %>
        <% relate_id ||=  stat.relate_id %>
        <% periods.push stat.period %>
        <% str[:total] ||= [] %>
        <% str[:total].push stat.total %>
        <% str[:opened] ||= [] %>
        <% str[:opened].push stat.opened %>
        <% str[:closed] ||= [] %>
        <% str[:closed].push stat.closed %>
        <% str[:returned] ||= [] %>
        <% str[:returned].push stat.returned %>
        <% str[:comment_max] ||= [] %>
        <% str[:comment_max].push stat.comment_max %>
        <% str[:returned_ratio] ||= [] %>
        <% str[:returned_ratio].push stat.returned_ratio %>
        <% str[:old_issues] ||= [] %>
        <% str[:old_issues].push stat.old_issues %>
        <% str[:opened_to_closed] ||= [] %>
        <% str[:opened_to_closed].push stat.opened_to_closed %>
      <% end %>
      <h3><%= statisticable.name %>  <%= relate_id && User.find(relate_id).name  %></h3>
      <% periods.each_with_index do |period, pidx| %>
      <script type="text/javascript" charset="utf-8">
        $(function () {
          new Highcharts.Chart({
            chart: { renderTo: '<%= stat_per_user %><%= period %>',
                     type: 'column',
            },
            title: { text: ''  },
            xAxis: {
              categories: [<%= raw period.to_json %>]
            },
            yAxis: {
              title: { text: '' },
              stackLabels: {
                style: {
                    color: 'black'
                },
                enabled: true
            }
            },
            credits: {
              text: ''
            },
            plotOptions: {
                  column: {
                    pointPadding: 0,
                    groupPadding: 0,
                    dataLabels: {
                      enabled: true
                    }
                  },
                  series: {
                    showInLegend: false,
                    cursor: 'pointer',
                    point: {
                        events: {
                            click: function (event) {
                                window.location.href = event.point.url + '<%= relate_id && "?relate_id=#{relate_id}" %>';
                            }
                        }
                    }
                  }
            },
            series: [{
              name: '<%=l(:field_total)%>',
              data: [{
                      y: <%= raw str[:total][pidx].to_json  %>,
                      url: 'http://localhost:3000/issue_statistics/total_issues/<%= stat_per_user %>/'+ <%= raw period.to_json %>
                    }]
            },
            {
              name: '<%=l(:field_opened)%>',
              data: [{
                      y: <%= raw str[:opened][pidx].to_json  %>,
                      url: 'http://localhost:3000/issue_statistics/opened_issues/<%= stat_per_user %>/'+ <%= raw period.to_json %>
                    }]
            },
            {
              name: '<%=l(:field_closed)%>',
              data: [{
                      y: <%= raw str[:closed][pidx].to_json  %>,
                      url: 'http://localhost:3000/issue_statistics/closed_issues/<%= stat_per_user %>/'+ <%= raw period.to_json %>
                    }]
            },
            {
              name: '<%=l(:field_returned)%>',
               data: [{
                      y: <%= raw str[:returned][pidx].to_json  %>,
                      url: 'http://localhost:3000/issue_statistics/returned_issues/<%= stat_per_user %>/'+ <%= raw period.to_json %>
                    }]
            },
            {
              name: '<%= l(:field_comment_max) %>',
              data: [{
                      y: <%= raw str[:comment_max][pidx].to_json  %>,
                      url: 'http://localhost:3000/issue_statistics/most_commented_issues/<%= stat_per_user %>/'+ <%= raw period.to_json %>
                    }]
            },
            {
              name: '<%= l(:field_old_issues) %>',
              data: [{
                      y: <%= raw str[:old_issues][pidx].to_json  %>,
                      url: 'http://localhost:3000/issue_statistics/older_issues/<%= stat_per_user %>/' + <%= raw period.to_json %>
                    }]
            }
            ]
          });
        });
      </script>
      <div>
        <div id="<%= stat_per_user %><%=  period %>" style="width: 250px; height: 300px; position: relative; margin: auto;"></div>
      </div>
      <% end %>
      <script type="text/javascript" charset="utf-8">
        $(function () {
          var ratio_all = Math.round(<%= raw str[:returned_ratio].last.to_json %> * 100 )/ 100;
          var difference_all = 100 - ratio_all;
          var ratio_year = Math.round(<%= raw str[:returned_ratio].last(2).first.to_json %> * 100 )/ 100;
          var difference_year = 100 - ratio_year;
          var ratio_month = Math.round(<%= raw str[:returned_ratio].first(2).last.to_json %> * 100 )/ 100;
          var difference_month = 100 - ratio_month;
          var ratio_week = Math.round(<%= raw str[:returned_ratio].first.to_json %> * 100 )/ 100;
          var difference_week = 100 - ratio_week;
          $('#<%= stat_per_user %>donut').highcharts({
              chart: {
                  type: 'pie',
                  name: 'Returned Issues',
                  options3d: {
                  enabled: false,
                  alpha: 0
                  }
              },

              title: {
                  text: ''
              },tooltip: {
                  enabled: false
              },
              credits: {
                text: ''
              },
              plotOptions: {
                  pie: {
                      innerSize: 170,
                  },
                  series: {
                    cursor: 'pointer',
                    point: {
                        events: {
                            click: function (event) {
                                if (event.point.url){
                                  window.location.href = event.point.url;
                                }
                            }
                        }
                    }
                  }
              },
              series: [
              {
                      name: 'WEEK',
                      colors: ['#f7a35c', '#C4BCC3'],
                      data: [
                              {
                                name: "<%=l(:field_week)%> " + ratio_week + "%",
                                y: ratio_week,
                                url: 'http://localhost:3000/issue_statistics/returned_issues/<%= stat_per_user %>/week',

                              },
                          ["", difference_week]
                      ],
                      color: 'black',
                      startAngle: 0,
                      distance: -30
                  },
                  {
                      name: 'MONTH',
                      colors: ['#f7a35c', '#C4BCC3'],
                      data: [
                              {
                                name: "<%=l(:field_month)%> " + ratio_month + "%",
                                y: ratio_month,
                                url: 'http://localhost:3000/issue_statistics/returned_issues/<%= stat_per_user %>/month'
                              },
                              ["", difference_month]
                            ],
                      size: '65%',
                      startAngle: 90,
                      innerSize: '62%',

                  },
                  {
                      name: 'YEAR',
                      colors: ['#f7a35c', '#C4BCC3'],
                      data: [
                              {
                                name: "<%=l(:field_year)%> " + ratio_year + "%",
                                y: ratio_year,
                                url: 'http://localhost:3000/issue_statistics/returned_issues/<%= stat_per_user %>/year'
                              },
                              ["", difference_year]
                            ],
                      size: '55%',
                      startAngle: 180,
                      innerSize: '52%',
                  },
                  {   
                      colors: ['#f7a35c', '#C4BCC3'],
                      data: [
                              {
                                name: "<%=l(:all)%> " + ratio_all + "%",
                                y: ratio_all,
                                url: 'http://localhost:3000/issue_statistics/returned_issues/<%= stat_per_user %>/all'
                              },
                              ["", difference_all]
                            ],
                      size: '45%',
                      startAngle: 270,
                      innerSize: '42%',
                  }]
          });
        });
      </script>
      <div class="clear">
        <div id="<%= stat_per_user %>donut" style="width: 500px; height: 300px; position: relative; float: left;"></div>
      </div>
     <script type="text/javascript" charset="utf-8">
        $(function () {
          var ratio_all = Math.round(<%= raw str[:opened_to_closed].last.to_json %> * 100 )/ 100;
          var difference_all = 100 - ratio_all;
          var ratio_year = Math.round(<%= raw str[:opened_to_closed].last(2).first.to_json %> * 100 )/ 100;
          var difference_year = 100 - ratio_year;
          var ratio_month = Math.round(<%= raw str[:opened_to_closed].first(2).last.to_json %> * 100 )/ 100;
          var difference_month = 100 - ratio_month;
          var ratio_week = Math.round(<%= raw str[:opened_to_closed].first.to_json %> * 100 )/ 100;
          var difference_week = 100 - ratio_week;
          $('#<%= stat_per_user %>donut_open_to_close').highcharts({
              chart: {
                  type: 'pie',
                  name: 'Open to Close Issues',
                  options3d: {
                  enabled: false,
                  alpha: 0
                  }
              },

              title: {
                  text: ''
              },tooltip: {
                  enabled: false
              },
              credits: {
                text: ''
              },
              plotOptions: {
                  pie: {
                      innerSize: 170,
                  },
                  series: {
                    cursor: 'pointer',
                    point: {
                        events: {
                            click: function (event) {
                                if (event.point.url){
                                  window.location.href = event.point.url + '<%= relate_id && "?relate_id=#{relate_id}" %>';
                                }
                            }
                        }
                    }
                  }
              },
              series: [
              {
                      colors: ['#F7BB83', '#D99077'],
                      data: [
                              {
                                name: "<%=l(:closed_in_week)%>",
                                y: ratio_week,
                                url: 'http://localhost:3000/issue_statistics/closed_issues/<%= stat_per_user %>/week'
                              },
                              {
                                name: "<%=l(:opened_in_week)%>",
                                y: difference_week,
                                url: 'http://localhost:3000/issue_statistics/opened_issues/<%= stat_per_user %>/week',
                                dataLabels: {
                                        enabled: true,
                                        color: '#f95b24'
                                }
                              }
                      ],
                      color: 'black',
                      distance: -30,
                      startAngle: 0
                  },
                  {
                      colors: ['#F7BB83', '#D99077'],
                      data: [
                              {
                                name: "<%=l(:closed_in_month)%>",
                                y: ratio_month,
                                url: 'http://localhost:3000/issue_statistics/closed_issues/<%= stat_per_user %>/month'
                              },
                              {
                                name: "<%=l(:opened_in_month)%>",
                                y: difference_month,
                                url: 'http://localhost:3000/issue_statistics/opened_issues/<%= stat_per_user %>/month',
                                dataLabels: {
                                        enabled: true,
                                        color: '#f95b24'
                                }
                              }
                            ],
                      size: '65%',
                      innerSize: '62%',
                      startAngle: 45

                  },
                  {
                      colors: ['#F7BB83', '#D99077'],
                      data: [
                              {
                                name: "<%=l(:closed_in_year)%>",
                                y: ratio_year,
                                url: 'http://localhost:3000/issue_statistics/closed_issues/<%= stat_per_user %>/year'
                              },
                              {
                                name: "<%=l(:opened_in_year)%>",
                                y: difference_year,
                                url: 'http://localhost:3000/issue_statistics/opened_issues/<%= stat_per_user %>/year',
                                dataLabels: {
                                        enabled: true,
                                        color: '#f95b24'
                                }
                              }
                            ],
                      size: '55%',
                      innerSize: '52%',
                      startAngle: 90
                  },
                  {
                      colors: ['#F7BB83', '#D99077'],
                      data: [
                              {
                                name: "<%=l(:closed_all)%>",
                                y: ratio_all,
                                url: 'http://localhost:3000/issue_statistics/closed_issues/<%= stat_per_user %>/all'
                              },
                              {
                                name: "<%=l(:opened_all)%>",
                                y: difference_all,
                                url: 'http://localhost:3000/issue_statistics/opened_issues/<%= stat_per_user %>/all',
                                dataLabels: {
                                        enabled: true,
                                        color: '#f95b24'
                                }
                              }
                            ],
                      size: '45%',
                      innerSize: '42%',
                      startAngle: 130
                  }]
          });
        });
      </script>
      <div>
        <div id="<%= stat_per_user %>donut_open_to_close" style="width: 500px; height: 300px; position: relative; float: right;"></div>
      </div>
    <hr />
    <% end %>
  <% end %>
<div id="paginacja" class="pagination" style="text-align: center;">
   <%= will_paginate @issue_statistics %>
</div>
<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'chosen.css', :plugin => 'redmine_issue_statistics', :media => 'all' %>
  <%= stylesheet_link_tag 'application.css', :plugin => 'redmine_issue_statistics', :media => 'all' %>
  <%= javascript_include_tag 'chosen.jquery.min.js', :plugin => 'redmine_issue_statistics' %>
  <%= javascript_include_tag 'highcharts', :plugin => 'redmine_issue_statistics' %>
  <%= javascript_include_tag 'app', :plugin => 'redmine_issue_statistics' %>
<% end %>
