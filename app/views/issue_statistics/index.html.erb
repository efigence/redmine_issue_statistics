<%= render :partial => 'search' %>
<hr />
<% if @issue_statistics.empty? %>
  <p class="nodata"><%= l(:label_no_data_or_access_denied) %></p>
<% else %>
  <% @issue_statistics.group_by(&:statisticable_id).each do |stat_per_user, tab| %>
    <% periods = [] %>
    <% str = {} %>
    <% statisticable =  nil %>
    <% relate_id =  nil %>
    <% tab.each do |stat| %>
      <% statisticable ||=  stat.statisticable %>
      <% relate_id ||=  stat.relate_id %>
      <% periods.push stat.period %>
      <% str[:total] ||= [] %><% str[:total].push stat.total %>
      <% str[:opened] ||= [] %><% str[:opened].push stat.opened %>
      <% str[:closed] ||= [] %><% str[:closed].push stat.closed %>
      <% str[:returned] ||= [] %><% str[:returned].push stat.returned %>
      <% str[:comment_max] ||= [] %><% str[:comment_max].push stat.comment_max %>
      <% str[:returned_ratio] ||= [] %><% str[:returned_ratio].push stat.returned_ratio %>
      <% str[:old_issues] ||= [] %><% str[:old_issues].push stat.old_issues %>
      <% str[:opened_to_closed] ||= [] %><% str[:opened_to_closed].push stat.opened_to_closed %>
    <% end %>

    <h3><%= statisticable.name %>  <%= relate_id && User.find(relate_id).name  %></h3>

    <% periods.each_with_index do |period, pidx| %>
      <%= render :partial => 'main_chart', 
                 :locals => {period: period, stat_per_user: stat_per_user, relate_id: relate_id, str: str, pidx: pidx} %>
      <%= render :partial => 'returned_chart', 
                 :locals => { stat_per_user: stat_per_user, relate_id: relate_id, str: str, periods: periods } %>
      <%= render :partial => 'opened_to_closed_chart', 
                 :locals => { stat_per_user: stat_per_user, relate_id: relate_id, str: str, periods: periods } %>
      <div id="<%= stat_per_user %><%=  period %>" style="width: 250px; height: 300px; position: relative;"></div>
    <% end %>
    <div class="clear">
      <div id="<%= stat_per_user %>returned" style="width: 500px; height: 300px; position: relative; float: left;"></div>
    </div>
    <div>
      <div id="<%= stat_per_user %>open_close" style="width: 500px; height: 300px; position: relative; float: right;"></div>
    </div>     
  <% end %>
<% end %>

<hr />

<div id="paginacja" class="pagination" style="text-align: center;">
   <%= will_paginate @issue_statistics %>
</div>

<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'chosen.css', :plugin => 'redmine_issue_statistics', :media => 'all' %>
  <%= stylesheet_link_tag 'application.css', :plugin => 'redmine_issue_statistics', :media => 'all' %>
  <%= javascript_include_tag 'chosen.jquery.min.js', :plugin => 'redmine_issue_statistics' %>
  <%= javascript_include_tag 'highcharts', :plugin => 'redmine_issue_statistics' %>
  <%= javascript_include_tag 'app', :plugin => 'redmine_issue_statistics' %>
<% end %>